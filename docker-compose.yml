version: '3.8'

services:
  # OSS AI Analysis Stack
  ollama:
    image: ollama/ollama:latest
    container_name: cybersec-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
    restart: unless-stopped
    networks:
      - cybersec-network

  # OSS SIEM Analysis
  wazuh-manager:
    image: wazuh/wazuh-manager:4.7.0
    container_name: cybersec-wazuh-manager
    hostname: wazuh-manager
    restart: unless-stopped
    ports:
      - "1514:1514"
      - "1515:1515"
      - "514:514/udp"
      - "55000:55000"
    environment:
      - INDEXER_URL=https://wazuh-indexer:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=SecretPassword
      - FILEBEAT_SSL_VERIFICATION_MODE=full
      - SSL_CERTIFICATE_AUTHORITIES=/etc/ssl/root-ca.pem
      - SSL_CERTIFICATE=/etc/ssl/filebeat.pem
      - SSL_KEY=/etc/ssl/filebeat.key
      - API_USERNAME=wazuh-wui
      - API_PASSWORD=MyS3cr37P450r.*-
    volumes:
      - wazuh_api_configuration:/var/ossec/api/configuration
      - wazuh_etc:/var/ossec/etc
      - wazuh_logs:/var/ossec/logs
      - wazuh_queue:/var/ossec/queue
      - wazuh_var_multigroups:/var/ossec/var/multigroups
      - wazuh_integrations:/var/ossec/integrations
      - wazuh_active_response:/var/ossec/active-response/bin
      - wazuh_agentless:/var/ossec/agentless
      - wazuh_wodles:/var/ossec/wodles
      - filebeat_etc:/etc/filebeat
      - filebeat_var:/var/lib/filebeat
    networks:
      - cybersec-network

  # OSS Runtime Security Analysis
  falco:
    image: falcosecurity/falco:0.36.2
    container_name: cybersec-falco
    privileged: true
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/host/var/run/docker.sock
      - /dev:/host/dev
      - /proc:/host/proc:ro
      - /boot:/host/boot:ro
      - /lib/modules:/host/lib/modules:ro
      - /usr:/host/usr:ro
      - /etc:/host/etc:ro
      - ./config/oss/falco:/etc/falco
    command:
      - /usr/bin/falco
      - --cri
      - /run/containerd/containerd.sock
      - -K
      - /var/run/secrets/kubernetes.io/serviceaccount/token
      - -k
      - https://kubernetes.default
      - -pk
    networks:
      - cybersec-network

  # OSS Analytics Engine
  duckdb:
    image: marcboeker/duckdb:latest
    container_name: cybersec-duckdb
    ports:
      - "5432:5432"
    volumes:
      - duckdb_data:/data
      - ./data/analysis:/analysis:ro
    environment:
      - DUCKDB_DATABASE=/data/security_analysis.db
    restart: unless-stopped
    networks:
      - cybersec-network

  # OSS S3-Compatible Storage
  minio:
    image: minio/minio:latest
    container_name: cybersec-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin123
      - MINIO_BROWSER_REDIRECT_URL=http://localhost:9001
    command: server /data --console-address ":9001"
    restart: unless-stopped
    networks:
      - cybersec-network

  # OSS Metrics Collection
  prometheus:
    image: prom/prometheus:latest
    container_name: cybersec-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./config/oss/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    restart: unless-stopped
    networks:
      - cybersec-network

  # OSS Visualization and Dashboards
  grafana:
    image: grafana/grafana:latest
    container_name: cybersec-grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./config/oss/grafana:/etc/grafana/provisioning
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin123
      - GF_USERS_ALLOW_SIGN_UP=false
    restart: unless-stopped
    networks:
      - cybersec-network

  # OSS Vector Database for AI Context
  chromadb:
    image: chromadb/chroma:latest
    container_name: cybersec-chromadb
    ports:
      - "8000:8000"
    volumes:
      - chromadb_data:/chroma/chroma
    environment:
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
    restart: unless-stopped
    networks:
      - cybersec-network

volumes:
  ollama_data:
  wazuh_api_configuration:
  wazuh_etc:
  wazuh_logs:
  wazuh_queue:
  wazuh_var_multigroups:
  wazuh_integrations:
  wazuh_active_response:
  wazuh_agentless:
  wazuh_wodles:
  filebeat_etc:
  filebeat_var:
  duckdb_data:
  minio_data:
  prometheus_data:
  grafana_data:
  chromadb_data:

networks:
  cybersec-network:
    driver: bridge